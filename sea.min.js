"use strict";function _toConsumableArray(n){if(Array.isArray(n)){for(var e=0,t=Array(n.length);e<n.length;e++)t[e]=n[e];return t}return Array.from(n)}!function(){var n,e,t,r,i,o,a,u=("undefined"!=typeof window?window:global).Gun,c=window.crypto||window.msCrypto;function f(){}function s(){return console.warn("new SafeBuffer() is depreciated, please use SafeBuffer.from()"),s.from.apply(s,arguments)}n=c.subtle||c.webkitSubtle,i=function(n){return l.from(c.getRandomValues(new Uint8Array(l.alloc(n))))},t=window.TextEncoder,r=window.TextDecoder,o=window.sessionStorage,window.localStorage,a=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB||window.shimIndexedDB,Object.assign(f,{from:Array.from}),f.prototype=Object.create(Array.prototype),f.prototype.toString=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"utf8",e=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments[2],i=this.length;if("hex"===n){var o=new Uint8Array(this);return[].concat(_toConsumableArray(Array((r&&r+1||i)-t).keys())).map(function(n){return o[n+t].toString(16).padStart(2,"0")}).join("")}return"utf8"===n?Array.from({length:(r||i)-t},function(n,r){return String.fromCharCode(e[r+t])}).join(""):"base64"===n?btoa(this):void 0},s.prototype=Object.create(Array.prototype),Object.assign(s,{from:function(){if(!Object.keys(arguments).length)throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.");var n=arguments[0],e=void 0;if("string"==typeof n){var t=arguments[1]||"utf8";if("hex"===t){var r=n.match(/([\da-fA-F]{2})/g).map(function(n){return parseInt(n,16)});if(!r||!r.length)throw new TypeError("Invalid first argument for type 'hex'.");e=f.from(r)}else if("utf8"===t){var i=n.length,o=new Uint16Array(i);Array.from({length:i},function(e,t){return o[t]=n.charCodeAt(t)}),e=f.from(o)}else if("base64"===t){var a=atob(n),u=a.length,c=new Uint8Array(u);Array.from({length:u},function(n,e){return c[e]=a.charCodeAt(e)}),e=f.from(c)}else"binary"===t?e=f.from(n):console.info("SafeBuffer.from unknown encoding: '"+t+"'");return e}var s=n.byteLength,l=n.length;if(void 0===l?s:l){var h=void 0;return n instanceof ArrayBuffer&&(h=new Uint8Array(n)),f.from(h||n)}},alloc:function(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return f.from(new Uint8Array(Array.from({length:n},function(){return e})))},allocUnsafe:function(n){return f.from(new Uint8Array(Array.from({length:n})))},concat:function(n){if(!Array.isArray(n))throw new TypeError("First argument must be Array containing ArrayBuffer or Uint8Array instances.");return f.from(n.reduce(function(n,e){return n.concat(Array.from(e))},[]))}}),s.prototype.from=s.from,s.prototype.toString=f.prototype.toString;var l=s,h={hash:"SHA-256",iter:5e4,ks:64},p={name:"ECDSA",hash:{name:"SHA-256"}},d={name:"ECDSA",namedCurve:"P-256"},v={name:"ECDH",namedCurve:"P-256"},y={validity:43200,hook:function(n){return n}},b={validity:y.validity,hook:y.hook};function g(n,e){var t=l.from(n,"base64").toString("utf8").split(":"),r=e?{d:e,key_ops:["sign"]}:{key_ops:["verify"]};return Object.assign(r,{kty:"EC",crv:"P-256",x:t[0],y:t[1],ext:!1})}function m(n,e){return new Promise(function(t,r){e.get("alias/"+n).get(function(n,i){if(i.off(),!n.put){var o="No user!";return u.log(o),r(o)}var a=[],c=0;u.obj.map(n.put,function(n,r){r.slice&&"pub/"===r.slice(0,4)&&(c++,e.get(r).get(function(n,e){r=r.slice(4),e.off(),c--,n.put&&a.push({pub:r,at:n}),!c&&(c=-1)&&t(a)}))}),c||r("Public key does not exist!")})})}function w(n,e,t){return new Promise(function(r,i){m(n,t).then(function(n){n.forEach(function(t,o){var a=t.at,u=t.pub,c=n.length-o>1;if(!a.put)return!c&&i({err:"Public key does not exist!"});var f=a.put.auth;return f=f.slice?JSON.parse(f):f,C.proof(e,f.salt).catch(function(n){i({err:"Failed to create proof!"})}).then(function(n){var e={pub:u,proof:n,at:a};C.dec(f.auth,{pub:u,key:n}).catch(function(n){i({err:"Failed to decrypt secret!"})}).then(function(n){if(n){e.priv=n.priv,e.salt=f.salt;var t=a.put.epub;Object.assign(e,{epub:t,epriv:n.epriv}),r(e)}else c||i({err:"Public key does not exist!"})}).catch(function(n){i({err:"Failed read secret!"})})})})}).catch(function(n){i({err:n})})})}function k(n,e,t,r){var i=t._.user;return i._=e.at.gun._,i._.is=i.is={},i._.alias=n,i._.sea={priv:e.priv,epriv:e.epriv,pub:e.pub,epub:e.epub},i._.pub=e.pub,i._.epub=e.epub,A(i._,e.proof,r).then(function(){try{t._.on("auth",i._)}catch(n){console.log("Your 'auth' callback crashed with:",n)}return i._})}function S(n,e,t){return function(r){return new Promise(function(i,a){if(!u.obj.has(r,"alias"))return i();if(b.validity&&n&&u.obj.has(r,"iat")){r.proof=n,delete r.remember;var c={alias:r.alias,pin:t},f=r;return C.write(JSON.stringify(c),e).then(function(n){o.setItem("user",r.alias),o.setItem("remember",n)}).then(function(){return!f||C.enc(f,t).then(function(n){return n&&C.write(n,e).then(function(n){return new Promise(function(e){C._callonstore_(function(n){n.clear().onsuccess=function(){}},function(){C._callonstore_(function(e){e.put({id:r.alias,auth:n})},function(){e()})})})}).catch(a)}).catch(a)}).then(function(){i(r)}).catch(function(n){a({err:"Session persisting failed!"})})}return new Promise(function(n){C._callonstore_(function(n){n.clear().onsuccess=function(){}},function(){n()})}).then(function(){o.removeItem("user"),o.removeItem("remember"),i(r)})})}}function A(n,e,t){var r=u.obj.has(t,"pin")&&t.pin||u.text.random(10);if(r=l.from(r,"utf8").toString("base64"),e&&n&&n.alias&&b.validity){var i={alias:n.alias};i.iat=Math.ceil(Date.now()/1e3),i.exp=b.validity,u.obj.has(t,"pin")&&(i.remember=!0);var o=b.hook(i),a={pub:n.pub,priv:n.sea.priv,epub:n.epub,epriv:n.sea.epriv};return o instanceof Promise?o.then(S(e,a,r)):S(e,a,r)(o)}return S()({alias:"delete"})}function _(n,e){return new Promise(function(t,r){var i,a=e||o.getItem("remember"),c=u.obj.has(e,"alias")&&e.alias||o.getItem("user"),f=u.obj.has(e,"pin")&&l.from(e.pin,"utf8").toString("base64"),s=function(n){if(u.obj.has(n,"proof")&&u.obj.has(n,"alias")&&n.alias===c){var e=n.proof,t=n.iat;delete n.proof;var r=function(n){if(Math.floor(Date.now()/1e3)<t+n.exp)return n.iat=t,n.proof=e,n;u.log("Authentication expired!")},i=b.hook(n);return i instanceof Promise&&i.then(r)||r(i)}};return n._.user&&u.obj.has(n._.user._,"pub")&&u.obj.has(n._.user._,"sea")?t(n._.user._):c&&a?m(c,n).then(function(n){return new Promise(function(e,t){n.forEach(function(r,i){var o=r.at,l=r.pub,h=n.length-i>1;return o.put?(f&&Promise.resolve({pin:f,alias:c})||C.read(a,l,!0)).then(function(n){try{n=n.slice?JSON.parse(n):n}catch(n){}return u.obj.has(n,"pin")&&u.obj.has(n,"alias")&&n.alias===c?(f=n.pin,new Promise(function(n){var e;C._callonstore_(function(n){var t=n.get(c);t.onsuccess=function(){e=t.result&&t.result.auth}},function(){return(t=e,r=l,i=f,C.read(t,r).then(function(n){return C.dec(n,i)}).then(function(n){try{return n.slice?JSON.parse(n):n}catch(n){}return n})).then(s).then(n).catch(function(){n()});var t,r,i})})):s(n)}).then(function(n){var r=n&&n.proof;if(!r)return!n&&t({err:"No valid authentication session found!"})||S()(n).then(function(){t({err:"Expired session!"})}).catch(function(){t({err:"Expired session!"})});var i=JSON.parse(o.put.auth).auth;return C.dec(i,r).catch(function(n){return!h&&t({err:"Failed to decrypt private key!"})}).then(function(n){if(n){var e=o.put.epub;return{pub:l,priv:n.priv,epriv:n.epriv,epub:e}}}).then(function(i){return S(r,i,f)(n).then(function(){return h?void 0:i?e(Object.assign(i,{at:o,proof:r})):t({err:"Failed to decrypt private key!"})}).catch(function(n){t({err:"Failed to store credentials!"})})}).catch(function(n){t({err:"Failed read secret!"})})}).catch(function(n){t({err:"Failed to access stored credentials!"})}):!h&&t({err:"Public key does not exist!"})})})}).then(function(e){k(c,e,n,f=f&&{pin:f}).then(t).catch(function(n){u.log("Failed to finalize login with new password!"),r({err:"Finalizing new password login failed! Reason: "+(n&&n.err)||n||""})})}).catch(function(n){r({err:"No authentication session found!"})}):c?void C._callonstore_(function(n){var e=n.get(c);e.onsuccess=function(){i=e.result&&e.result.auth}},function(){r({err:i&&b.validity?"Missing PIN and alias!":"No authentication session found!"})}):r({err:"No authentication session found!"})})}function j(n,e){return function(t,r){var i=n._.user||{_:{}};n._.user=null;var o=function(){["alias","sea","pub"].forEach(function(n){delete i._[n]}),i._.is=i.is={},n.user(),t({ok:0})};A((e=e||i._.alias)&&{alias:e}).then(o).catch(o)}}function x(e,t,r){r=r||["encrypt","decrypt"];var o=function(e){return(o=u.obj.has(e,"key")&&e.key||e,a=t||i(8),P(l.concat([l.from(o,"utf8"),a]).toString("utf8")).then(function(n){return l.from(n,"binary")})).then(function(e){return n.importKey("raw",new Uint8Array(e),"AES-CBC",!1,r)});var o,a};return new Promise(function(n){if(b.validity&&"undefined"!=typeof window&&u.obj.has(e,"pub")&&u.obj.has(e,"key")){var t,r=function(){o(e).then(function(t){C._callonstore_(function(n){n.put({id:e.pub,key:t})},function(){n(t)})})};if(u.obj.has(e,"set"))return r();C._callonstore_(function(n){var r=n.get(e.pub);r.onsuccess=function(){t=r.result&&r.result.key}},function(){return t?n(t):r()})}else o(e).then(function(e){n(e)})})}function P(r){var i=e||n;try{r=r.slice?r:JSON.stringify(r)}catch(n){}return i.digest(h.hash,(new t).encode(r)).then(function(n){return l.from(n)})}function E(){}function O(n){var e,t=this.to,r=(n.gun._.put,0);u.node.is(n.put,function(i,o,a){r++,C.read(i,!1).then(function(u){r--,a[o]=i=u,e&&!r&&(r=-1)&&t.next(n)})}),(e=!0)&&!r&&t.next(n)}function N(n){if(n.user)return this.to.next(n);var e=this.as;n.user=e.user,B.call(this,n)}function B(n){var e=this.as,t=(e.sea,this.to);if(n.get){var r=n.get["#"];if(r)return"alias"===r?t.next(n):(r.slice(0,6),t.next(n))}if(n.put){var i={},o=(u.on(),{});return o.node=function(n,e){if(u.obj.empty(n,"_"))return i["node"+e]=0;u.obj.map(n,o.way,{soul:e,node:n})},o.way=function(e,t){var r=this.soul,i=this.node;"_"!==t&&("alias"!==r?"alias/"!==r.slice(0,6)?"pub/"!==r.slice(0,4)?o.any(e,t,i,r,n.user):o.pub(e,t,i,r,r.slice(4),n.user):o.pubs(e,t,i,r):o.alias(e,t,i,r))},o.alias=function(n,e,t,r){return n?"alias/"+e===u.val.rel.is(n)?i["alias"+e]=0:void o.end({err:"Mismatching alias."}):o.end({err:"Data must exist!"})},o.pubs=function(n,e,t,r){return n?e===u.val.rel.is(n)?i["pubs"+r+e]=0:void o.end({err:"Alias must match!"}):o.end({err:"Alias must exist!"})},o.pub=function(n,t,r,a,c,f){if("pub"===t)return n===c?i["pub"+a+t]=0:o.end({err:"Account must match!"});if(i["user"+a+t]=1,f&&(f=f._)&&f.sea&&c===f.pub){u.text.random(3);C.write(n,u.obj.to(f.sea,{pub:f.pub,epub:f.epub}),function(f){var s;(s=u.val.rel.is(n))&&((e.sea.own[s]=e.sea.own[s]||{})[c]=!0),r[t]=f,i["user"+a+t]=0,o.end({ok:1})})}else C.read(n,c).then(function(n){var r,f;if(void 0===n)return o.end({err:"Unverified data."});(r=u.val.rel.is(n))&&(f=r.split("~"))&&2===f.length?C.verify(f[0],c,f[1],function(n){if(!n)return o.end({err:"Signature did not match account."});(e.sea.own[r]=e.sea.own[r]||{})[c]=!0,i["user"+a+t]=0,o.end({ok:1})}):(i["user"+a+t]=0,o.end({ok:1}))})},o.any=function(t,r,a,c,f){var s;if(!f||!(f=f._)||!(f=f.sea))return(f=e.sea.own[c])?(i["any"+c+r]=1,f=u.obj.map(f,function(n,e){return e}),void C.read(t,f,function(n){var t;if(!n)return o.end({err:"Mismatched owner on '"+r+"'."});(t=u.val.rel.is(n))&&(s=t.split("~"))&&2===s.length?C.verify(s[0],f,s[1],function(n){if(!n)return o.end({err:"Signature did not match account."});(e.sea.own[t]=e.sea.own[t]||{})[f]=!0,i["any"+c+r]=0,o.end({ok:1})}):(i["any"+c+r]=0,o.end({ok:1}))})):(i["any"+c+r]=1,(s=c.split("~"))&&2==s.length?void setTimeout(function(){o.any(t,r,a,c)},1):void e.on("secure",function(n){this.off(),i["any"+c+r]=0,o.end(n||{err:"Data cannot be modified."})}).on.on("secure",n));(s=c.split("~"))&&2===s.length?u.obj.map(e.sea.own[c],function(n,e){if(f.pub!==e)return e})?o.any(t,r,a,c):(i["any"+c+r]=1,C.verify(s[0],f.pub,s[1],function(n){if(!n)return o.end({err:"Signature did not match account at '"+r+"'."});(e.sea.own[c]=e.sea.own[c]||{})[f.pub]=!0,C.write(t,f,function(n){a[r]=n,i["any"+c+r]=0,o.end({ok:1})})})):o.end({err:"Soul is not signed at '"+r+"'."})},o.end=function(e){o.err||((o.err=e.err)||e.no?console.log("NO!",o.err,n.put):o.end.ed&&(u.obj.map(i,function(n){if(n)return!0})||t.next(n)))},u.obj.map(n.put,o.node),void o.end({end:o.end.ed=!0})}t.next(n)}u.chain.user=function(){var n=this.back(-1),e=n._.user||(n._.user=n.chain());return["create","auth","leave","delete","recall","alive"].forEach(function(n){e[n]=E[n]}),e},E.create=function(n,e,t){var r=this.back(-1),i=function(t,i){r.get("alias/"+n).get(function(o,a){if(a.off(),o.put){var c="User already created!";return u.log(c),i({err:c})}var f=u.text.random(64);C.proof(e,f).then(function(e){C.pair().then(function(o){var a={pub:o.pub};C.write(n,o).then(function(n){return a.alias=n,C.write(o.epub,o)}).then(function(n){return a.epub=n,C.enc({priv:o.priv,epriv:o.epriv},{pub:o.epub,key:e})}).then(function(n){return C.write(f,o).then(function(e){return C.write({salt:f,auth:n},o)})}).then(function(e){a.auth=e;var i="pub/"+o.pub;r.get(i).put(a),r.get("alias/"+n).put(u.obj.put({},i,u.val.rel.ify(i))),setTimeout(function(){t({ok:0,pub:o.pub})},10)}).catch(function(n){u.log("SEA.en or SEA.write calls failed!"),i(n)})}).catch(function(n){u.log("SEA.pair call failed!"),i(n)})})})};if(!t)return new Promise(i);i(t,t)},E.auth=function(n,e,t,r){var i=r||"function"!=typeof t&&t,o=this.back(-1),a=function(t,r){if(!e&&u.obj.has(i,"pin"))return _(o,{alias:n,pin:i.pin}).then(function(n){t(n)}).catch(function(n){r({err:"Auth attempt failed! Reason: No session data for alias & PIN"})});w(n,e,o).then(function(e){var a=u.obj.has(i,"pin")&&{pin:i.pin};if(u.obj.has(i,"newpass")){var c=u.text.random(64);C.proof(i.newpass,c).then(function(n){return C.enc({priv:e.priv,epriv:e.epriv},{pub:e.pub,key:n,set:!0}).then(function(n){return C.write({salt:c,auth:n},e)})}).then(function(t){return C.write(e.epub,e).then(function(r){return C.write(n,e).then(function(n){return{alias:n,auth:t,epub:r,pub:e.pub}})})}).then(function(i){var c="pub/"+i.pub;o.get(c).put(i),k(n,e,o,a).then(t).catch(function(n){u.log("Failed to finalize login with new password!"),r({err:"Finalizing new password login failed! Reason: "+(n&&n.err)||n||""})})}).catch(function(n){u.log("Failed encrypt private key using new password!"),r({err:"Password set attempt failed! Reason: "+(n&&n.err)||n||""})})}else k(n,e,o,a).then(t).catch(function(n){u.log("Failed to finalize login!"),r({err:"Finalizing login failed! Reason: "+(n&&n.err)||n||""})})}).catch(function(n){u.log("Failed to sign in!"),r({err:"Auth attempt failed! Reason: "+(n&&n.err)||n||""})})};if(!(t="function"==typeof t&&t))return new Promise(a);a(t,t)},u.chain.trust=function(n){u.is(n)&&n.get("pub").get(function(n,e){console.log(n,e)})},E.leave=function(n){var e=this.back(-1);if(!n)return new Promise(j(e));j(e)(n,n)},E.delete=function(n,e,t){var r=this.back(-1),i=function(t,i){w(n,e,r).then(function(e){new Promise(j(r,n)).catch(function(){}).then(function(){r.get("pub/"+e.pub).put(null);var n=r._.user||{_:{}};["alias","sea","pub"].forEach(function(e){delete n._[e]}),n._.is=n.is={},r.user(),t({ok:0})}).catch(function(n){u.log("User.delete failed! Error:",n),i({err:"Delete attempt failed! Reason: "+(n&&n.err)||n||""})})}).catch(function(n){u.log("User.delete authentication failed! Error:",n),i({err:"Delete attempt failed! Reason: "+(n&&n.err)||n||""})})};if(!t)return new Promise(i);i(t,t)},E.recall=function(n,e,t){var r,i,o,a=this.back(-1);t||"function"==typeof e||u.val.is(e)?i=e:o=e,i||("function"==typeof n?(i=n,r=y.validity):u.val.is(n)?r=60*n:(o=n,r=y.validity));var c=function(n,e){b.validity=void 0!==r?r:y.validity,b.hook=u.obj.has(o,"hook")&&"function"==typeof o.hook?o.hook:y.hook,_(a).then(n).catch(function(e){var t="No session!";u.log(t),n({err:e&&e.err||t})})};if(!i)return new Promise(c);c(i)},E.alive=function(n){var e=this.back(-1),t=function(n,t){_(e).then(function(){n(e._.user._)}).catch(function(n){var e="No session!";u.log(e),t({err:e})})};if(!n)return new Promise(t);t(n,n)},u.on("opt",function(n){if(!n.sea){n.sea={own:{}};var e=n.opt.uuid||u.state.lex;n.opt.uuid=function(t){if(t){var r=e(),i=n.user&&n.user._.sea;if(!i)return r;C.sign(r,i).then(function(n){t(null,r+"~"+n)}).catch(function(n){t(n)})}},n.on("in",B,n),n.on("out",N,n),n.on("node",O,n)}this.to.next(n)});var C={};C.Buffer=s,C.proof=function(e,r,o){var a="undefined"!=typeof window&&function(o,a){n.importKey("raw",(new t).encode(e),{name:"PBKDF2"},!1,["deriveBits"]).then(function(e){return n.deriveBits({name:"PBKDF2",iterations:h.iter,salt:(new t).encode(r),hash:h.hash},e,8*h.ks)}).then(function(n){return e=i(e.length),l.from(n,"binary").toString("base64")}).then(o).catch(function(n){u.log(n),a(n)})}||function(n,o){try{var a=crypto.pbkdf2Sync(e,(new t).encode(r),h.iter,h.ks,h.hash.replace("-","").toLowerCase());e=i(e.length),n(a&&a.toString("base64"))}catch(n){o(n)}};if(!o)return new Promise(a);a(o,function(){o()})},C.keyid=function(t,r){var i=function(r,i){var o,a=l.concat(l.from(t,"base64").toString("utf8").split(":").map(function(n){return l.from(n,"base64")})),u=l.concat([l.from([153,a.length/256,a.length%256]),a]);(o=u,(e||n).digest("SHA-1",new ArrayBuffer(o))).then(function(n){var e=l.from(n,"binary");r(e.toString("hex",e.length-8))})};if(!r)return new Promise(i);i(r)},C.pair=function(t){var r=function(t,r){return n.generateKey(d,!0,["sign","verify"]).then(function(e){var t=e.publicKey;return n.exportKey("jwk",e.privateKey).then(function(n){return{priv:n.d}}).then(function(e){return n.exportKey("jwk",t).then(function(n){return e.pub=l.from([n.x,n.y].join(":")).toString("base64"),e})}).catch(function(n){u.log(n),r(n)})}).then(function(t){var i=e||n;return i.generateKey(v,!0,["deriveKey"]).then(function(n){var e=n.publicKey;return i.exportKey("jwk",n.privateKey).then(function(n){return t.epriv=n.d,t}).then(function(n){return i.exportKey("jwk",e).then(function(e){return n.epub=l.from([e.x,e.y].join(":")).toString("base64"),n})}).catch(function(n){u.log(n),r(n)})}).catch(function(n){u.log(n),r(n)})}).then(t).catch(function(n){u.log(n),r(n)})};if(!t)return new Promise(r);r(t,function(){t()})},C.derive=function(t,r,i){var o=e||n,a=function(n,e){var t=l.from(n,"base64").toString("utf8").split(":"),r=e?{d:e,key_ops:["decrypt"]}:{key_ops:["encrypt"]};return Object.assign(r,{kty:"EC",crv:"P-256",x:t[0],y:t[1],ext:!1})},c=function(n,e){o.importKey("jwk",a(t),v,!1,["deriveKey"]).then(function(t){var i=t;o.importKey("jwk",a(r.epub,r.epriv),v,!1,["deriveKey"]).then(function(t){var r=Object.assign({},v);r.public=i,o.deriveKey(r,t,{name:"AES-CBC",length:256},!0,["encrypt","decrypt"]).then(function(e){o.exportKey("jwk",e).then(function(e){n(e.k)})}).catch(function(n){u.log(n),e(n)})}).catch(function(n){u.log(n),e(n)})}).catch(function(n){u.log(n),e(n)})};if(!i)return new Promise(c);c(i,function(){i()})},C.sign=function(e,t,r){var i=function(r,i){var o=g(t.pub,t.priv);P(e.slice?e:JSON.stringify(e)).then(function(e){n.importKey("jwk",o,d,!1,["sign"]).then(function(t){n.sign(p,t,new Uint8Array(e)).then(function(n){r(l.from(n,"binary").toString("base64"))}).catch(function(n){u.log(n),i(n)})}).catch(function(n){u.log(n),i(n)})})};if(!r)return new Promise(i);i(r,function(){r()})},C.verify=function(e,t,r,i){var o=function(i,o){n.importKey("jwk",g(t),d,!1,["verify"]).then(function(t){P(e).then(function(e){n.verify(p,t,new Uint8Array(l.from(r,"base64")),new Uint8Array(e)).then(function(n){i(n)}).catch(function(n){u.log(n),o(n)})})}).catch(function(n){u.log(n),o(n)})};if(!i)return new Promise(o);o(i,function(){i()})},C.enc=function(e,r,o){var a=function(o,a){var c=i(8),f=i(16),s={iv:f.toString("hex"),s:c.toString("hex")};e=e.slice&&e||JSON.stringify(e),x(r,c).then(function(r){n.encrypt({name:"AES-CBC",iv:new Uint8Array(f)},r,(new t).encode(e)).then(function(n){return r=i(32),s.ct=l.from(n,"binary").toString("base64"),JSON.stringify(s)}).then(o).catch(function(n){u.log(n),a(n)})}).catch(function(n){u.log(n),a(n)})};if(!o)return new Promise(a);a(o,function(){o()})},C.dec=function(e,t,o){var a=function(o,a){try{e=e.slice?JSON.parse(e):e}catch(n){}var c=new Uint8Array(l.from(e.iv,"hex")),f=new Uint8Array(l.from(e.s,"hex"));x(t,f).then(function(t){n.decrypt({name:"AES-CBC",iv:c},t,new Uint8Array(l.from(e.ct,"base64"))).then(function(n){t=i(32);var e=new r("utf8").decode(n);try{return e.slice?JSON.parse(e):e}catch(n){return e}}).then(o).catch(function(n){u.log(n),a(n)})}).catch(function(n){u.log(n),a(n)})};if(!o)return new Promise(a);a(o,function(){o()})},C.write=function(n,e,t){var r=function(t,r){var i=n;if(i&&i.slice&&"SEA["===i.slice(0,4))return t(i);if(n&&n.slice)for(;"SEA["===i.slice(0,4);)try{i=JSON.parse(i.slice(3))[0]}catch(n){break}i=i&&i.slice?i:JSON.stringify(i),C.sign(i,e).then(function(n){t("SEA"+JSON.stringify([i,n]))}).catch(function(n){u.log(n),r(n)})};if(!t)return new Promise(r);r(t,function(){t()})},C.read=function(n,e,t){var r=function(t,r){var i;if(!n)return!1===e?t(n):t();if(!n.slice||"SEA["!==n.slice(0,4))return!1===e?t(n):t();n=n.slice(3);try{n=n.slice?JSON.parse(n):n}catch(n){return r(n)}i=(n=n||"")[0];try{i=i.slice?JSON.parse(i):i}catch(n){}!1===e&&t(i),C.verify(n[0],e,n[1]).then(function(n){if(!n)return t();t(i)}).catch(function(n){r(n)})};if(!t||"function"!=typeof t)return new Promise(r);r(t,function(){t()})},C._callonstore_=function(n,e){var t=a.open("GunDB",1);t.onupgradeneeded=function(){t.result.createObjectStore("SEA",{keyPath:"id"})},t.onsuccess=function(){var r=t.result,i=r.transaction("SEA","readwrite"),o=i.objectStore("SEA");n(o),i.oncomplete=function(){r.close(),"function"==typeof e&&e()}}},u.SEA=C;try{module.exports=C}catch(n){}}();